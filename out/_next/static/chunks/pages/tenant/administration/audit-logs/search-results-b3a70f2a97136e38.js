(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1771],{18550:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/tenant/administration/audit-logs/search-results",function(){return r(27515)}])},27515:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>$});var i=r(37876),a=r(89099),n=r(14232),s=r(12435),l=r(29390),c=r(79803),o=r(46041),u=r(41412),d=r(35936),f=r(82557),p=r(22430),h=r(7957),m=r(22474),g=r(22322),y=r(17825);let x=e=>"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e),j=e=>"string"!=typeof e?[]:e.match(/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/gi)||[],A=e=>{let t;if("string"!=typeof e)return[];let r=[],i=/user_([0-9a-f]{32})@([^@]+\.onmicrosoft\.com)/gi;for(;null!==(t=i.exec(e));){let e=t[1],i=t[2];if(32===e.length){let t=[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20,32)].join("-");r.push({guid:t,tenantDomain:i})}}let a=/([^\\]+\.onmicrosoft\.com)\\tenant:\s*([0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}),\s*object:\s*([0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})/gi;for(;null!==(t=a.exec(e));){t[1];let e=t[2],i=t[3];r.push({guid:i,tenantDomain:e})}return r},v=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Set,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Map;if(!e)return{guidsSet:t,partnerGuidsMap:r};if("string"==typeof e){let i=A(e),a=new Set;i.forEach(e=>{let{guid:t,tenantDomain:i}=e;r.has(i)||r.set(i,new Set),r.get(i).add(t),a.add(t)}),x(e)?a.has(e)||t.add(e):j(e).forEach(e=>{a.has(e)||t.add(e)})}else Array.isArray(e)?e.forEach(e=>{let i=v(e,t,r);t=i.guidsSet,r=i.partnerGuidsMap}):"object"==typeof e&&Object.values(e).forEach(e=>{let i=v(e,t,r);t=i.guidsSet,r=i.partnerGuidsMap});return{guidsSet:t,partnerGuidsMap:r}},b=(e,t,r,i)=>{let a;if("string"!=typeof e)return{result:e,hasResolvedNames:!1};let n=e,s=!1;(e.match(/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/gi)||[]).forEach(e=>{t[e]&&(n=n.replace(RegExp(e,"gi"),t[e]),s=!0)});let l=/user_([0-9a-f]{32})@([^@]+\.onmicrosoft\.com)/gi,c=String(e);for(;null!==(a=l.exec(c));){let e=a[0],i=a[1];if(32===i.length){let a=[i.slice(0,8),i.slice(8,12),i.slice(12,16),i.slice(16,20),i.slice(20,32)].join("-");r[a]?(n=n.replace(RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),r[a]),s=!0):t[a]&&(n=n.replace(RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),t[a]),s=!0)}}return{result:n,hasResolvedNames:s}},S=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=(0,y.t)().currentTenant,r=e||t,[i,a]=(0,n.useState)({}),[s,l]=(0,n.useState)({}),[c,o]=(0,n.useState)(!1),u=(0,n.useRef)(new Set),d=(0,n.useRef)([]),f=(0,n.useRef)(new Map),p=(0,n.useRef)(0),h=(0,n.useRef)(0),m=(0,n.useRef)(2e3),j=(0,n.useRef)(null),S=(0,n.useCallback)(function(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;j.current&&clearTimeout(j.current),j.current=setTimeout(()=>{e.mutate({url:t,data:r}),j.current=null},i||m.current),m.current=Math.min(1.5*m.current,1e4)},[]),w=(0,g.nN)({relatedQueryKeys:["directoryObjects"],onResult:e=>{if(e&&429===e.statusCode){console.log("Rate limit hit on directory objects lookup, retrying...");let t=2;if(e.message&&"string"==typeof e.message){let r=e.message.match(/Try again in (\d+) seconds/i);r&&r[1]&&(t=parseInt(r[1],10)||2)}S(w,"/api/ListDirectoryObjects",{tenantFilter:r,ids:d.current,$select:"id,displayName,userPrincipalName,mail"},1e3*t);return}if(m.current=2e3,e&&Array.isArray(e.value)){let t={},i={};e.value.forEach(e=>{e.id&&((e.displayName||e.userPrincipalName||e.mail)&&(t[e.id]=e.displayName||e.userPrincipalName||e.mail),e.userPrincipalName&&(i[e.id]=e.userPrincipalName))});let n=new Set(d.current),s=new Set(e.value.map(e=>e.id)),c=[...n].filter(e=>!s.has(e));if(c.length>0){console.log("".concat(c.length," GUIDs not resolved by primary tenant, trying partner tenant lookup")),f.current.has(r)||f.current.set(r,new Set),c.forEach(e=>{f.current.get(r).add(e)});let e=Date.now();!j.current&&e-h.current>=2e3&&(h.current=e,console.log("Sending partner fallback request for ".concat(c.length," GUIDs in tenant ").concat(r)),N.mutate({url:"/api/ListDirectoryObjects",data:{tenantFilter:r,ids:c,$select:"id,displayName,userPrincipalName,mail",partnerLookup:!0}}))}a(e=>({...e,...t})),l(e=>({...e,...i})),d.current=[],0===c.length&&o(!1)}}}),N=(0,g.nN)({relatedQueryKeys:["partnerDirectoryObjects"],onResult:e=>{if(e&&429===e.statusCode){console.log("Rate limit hit on partner directory objects lookup, retrying...");let t=2;if(e.message&&"string"==typeof e.message){let r=e.message.match(/Try again in (\d+) seconds/i);r&&r[1]&&(t=parseInt(r[1],10)||2)}let r=[...f.current.entries()];if(r.length>0){let[e,i]=r[0];S(N,"/api/ListDirectoryObjects",{tenantFilter:e,ids:Array.from(i),$select:"id,displayName,userPrincipalName,mail"},1e3*t)}return}if(m.current=2e3,e&&Array.isArray(e.value)){let t={},r={};e.value.forEach(e=>{e.id&&((e.userPrincipalName||e.mail||e.displayName)&&(t[e.id]=e.userPrincipalName||e.mail||e.displayName),e.userPrincipalName&&(r[e.id]=e.userPrincipalName))});let i=new Set;f.current.forEach(e=>{e.forEach(e=>i.add(e))});let n=new Set(e.value.map(e=>e.id)),s=[...i].filter(e=>!n.has(e));s.length>0&&s.forEach(e=>u.current.add(e)),a(e=>({...e,...t})),l(e=>({...e,...r})),f.current=new Map,o(!1)}}}),D=(0,n.useCallback)(e=>{let{guidsSet:t,partnerGuidsMap:a}=v(e);if(t.size>0){let e=Array.from(t).filter(e=>!i[e]&&!u.current.has(e));if(e.length>0){let t=[...new Set([...d.current,...e])];d.current=t,o(!0);let i=Date.now();if(!j.current&&i-p.current>=2e3){p.current=i;let e=t.slice(0,1e3);e.length>0?(console.log("Sending primary tenant request for ".concat(e.length," GUIDs in tenant ").concat(r)),w.mutate({url:"/api/ListDirectoryObjects",data:{tenantFilter:r,ids:e,$select:"id,displayName,userPrincipalName,mail"}})):o(!1)}}}a.size>0&&a.forEach((e,t)=>{let r=Array.from(e).filter(e=>!i[e]&&!u.current.has(e));if(r.length>0){f.current.has(t)||f.current.set(t,new Set),r.forEach(e=>f.current.get(t).add(e)),o(!0);let e=Date.now();if(!j.current&&e-h.current>=2e3){h.current=e;let i=r.slice(0,1e3);i.length>0&&(console.log("Sending partner tenant request for ".concat(i.length," GUIDs in tenant ").concat(t)),N.mutate({url:"/api/ListDirectoryObjects",data:{tenantFilter:t,ids:i,$select:"id,displayName,userPrincipalName,mail"}}))}}}),0===t.size&&0===a.size&&o(!1)},[i,r,w,N]),I=(0,n.useCallback)(e=>b(e,i,s,c),[i,s,c]);return(0,n.useEffect)(()=>()=>{j.current&&(clearTimeout(j.current),j.current=null)},[]),{guidMapping:i,upnMapping:s,isLoadingGuids:c,resolveGuids:D,isGuid:x,extractObjectIdFromPartnerUPN:A,replaceGuidsAndUpnsInString:I}};var w=r(5419);let N=e=>{let{row:t}=e,{guidMapping:r,upnMapping:a,isLoadingGuids:s,resolveGuids:l,isGuid:c,replaceGuidsAndUpnsInString:o}=S();(0,n.useEffect)(()=>{t&&(l(t),t.auditData&&l(t.auditData))},[null==t?void 0:t.id,l]);let g=e=>{let t;if("string"!=typeof e)return e;let{result:r,hasResolvedNames:a}=o(e);if(a)return(0,i.jsx)(p.A,{title:"Original: ".concat(e),placement:"top",children:(0,i.jsx)("span",{children:r})});let n=/user_([0-9a-f]{32})@([^@]+\.onmicrosoft\.com)/gi,l=/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/gi.test(e);n.lastIndex=0;let c=!1;for(;null!==(t=n.exec(e));){let e=t[1];if(e&&32===e.length){c=!0;break}}return(l||c)&&s?(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,i.jsx)(h.A,{size:16,sx:{mr:1}}),(0,i.jsx)("span",{children:e})]}):e},y=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e?Object.entries(e).map(e=>{let r,[a,n]=e;if(["selectedOption","GUID","ID","id","noSubmitButton"].includes(a)||t&&"auditData"===a)return null;if("string"==typeof n&&c(n))r=x(n);else if("string"==typeof n&&n.match(/^user_[0-9a-f]{32}@[^@]+\.onmicrosoft\.com$/i))r=x(n);else if(a.toLowerCase().includes("clientip")&&n&&null!==n&&b(n)){let e=N(n);r=(0,i.jsx)("div",{children:(0,i.jsx)(f.A,{ipAddress:e,displayIpAddress:n,showIpAddress:!0})})}else if("string"==typeof n){let e=g(n);r="object"==typeof e&&(null==e?void 0:e.type)?e:(0,d.i)(e,a)}else r="object"==typeof n&&null!==n?j(n):(0,d.i)(n,a);return{label:(0,u.i)(a),value:r}}).filter(Boolean):[]},x=e=>{if(r[e])return(0,i.jsx)(p.A,{title:"GUID: ".concat(e),placement:"top",children:(0,i.jsx)("span",{children:r[e]})});let t="string"==typeof e?e.match(/^user_([0-9a-f]{32})@([^@]+\.onmicrosoft\.com)$/i):null;if(t){let n=t[1];if(n&&32===n.length){let t=[n.slice(0,8),n.slice(8,12),n.slice(12,16),n.slice(16,20),n.slice(20,32)].join("-");if(a&&a[t])return(0,i.jsx)(p.A,{title:"Original UPN: ".concat(e),placement:"top",children:(0,i.jsx)("span",{children:a[t]})});if(r[t])return(0,i.jsx)(p.A,{title:"UPN: ".concat(e),placement:"top",children:(0,i.jsx)("span",{children:r[t]})})}}return s?(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,i.jsx)(h.A,{size:16,sx:{mr:1}}),(0,i.jsx)("span",{children:e})]}):(0,i.jsx)(p.A,{title:"This identifier could not be resolved to a directory object name",placement:"top",children:(0,i.jsx)("span",{style:{fontFamily:"monospace",fontSize:"0.9em"},children:e})})},j=e=>Array.isArray(e)?A(e):"object"==typeof e&&null!==e?v(e):(0,d.i)(e,"nested"),A=e=>0===e.length?"[]":e.length<=5&&e.every(e=>"object"!=typeof e)?(0,i.jsx)("div",{children:e.map((e,t)=>(0,i.jsx)("div",{style:{marginBottom:"2px"},children:"string"==typeof e&&c(e)?x(e):"string"==typeof e?g(e):(0,d.i)(e,"item-".concat(t))},t))}):(0,d.i)(e,"array"),v=e=>{let t=Object.entries(e);return t.length<=3&&t.every(e=>{let[,t]=e;return"object"!=typeof t})?(0,i.jsx)("div",{children:t.map(e=>{let[t,r]=e;return(0,i.jsxs)("div",{style:{marginBottom:"2px"},children:[(0,i.jsxs)("strong",{children:[(0,u.i)(t),":"]})," ","string"==typeof r&&c(r)?x(r):"string"==typeof r?g(r):(0,d.i)(r,t)]},t)})}):(0,d.i)(e,"object")},b=e=>{if("string"!=typeof e)return!1;let t=e,r=null,i=e.match(/^(.+):(\d+)$/);i&&(t=i[1],r=i[2]);let a=e.match(/^\[(.+)\]:(\d+)$/);if(a&&(t=a[1],r=a[2]),null!==r){let e=parseInt(r,10);if(e<1||e>65535)return!1}return/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(t)||/^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$|^::1$|^::$/.test(t)},N=e=>{if("string"!=typeof e)return e;let t=e.match(/^(.+):(\d+)$/);if(t)return t[1];let r=e.match(/^\[(.+)\]:(\d+)$/);return r?r[1]:e},D=y(t,!0),I=(null==t?void 0:t.auditData)?y(t.auditData):[];return(0,i.jsxs)(m.A,{spacing:3,children:[(0,i.jsx)(w.a,{title:"Audit Log Details",propertyItems:D,layout:"double",cardSx:{width:"100%"},showDivider:!1}),I.length>0&&(0,i.jsx)(w.a,{title:"Audit Data",propertyItems:I,layout:"double",cardSx:{width:"100%"},showDivider:!1})]})};var D=r(67578),I=r(47737),P=r(94810),E=r(99439),R=r(82836);let L=["createdDateTime","userPrincipalName","operation","service","auditLogRecordType","clientIp","Actions"],k=()=>{let e=(0,a.useRouter)(),[t,r]=(0,n.useState)(null),[s,u]=(0,n.useState)(null),[d,f]=(0,n.useState)(!1),p=(0,R.s)();if((0,n.useEffect)(()=>{e.isReady&&(r(e.query.id||e.query.searchId),u(e.query.name?decodeURIComponent(e.query.name):null),f(!0))},[e.isReady,e.query.id,e.query.searchId,e.query.name]),!d)return(0,i.jsx)("div",{children:"Loading..."});if(!t)return(0,i.jsx)("div",{children:"Search ID is required"});let h=s?"".concat(s):"Search Results - ".concat(t);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(l.a,{title:h,cardButton:(0,i.jsxs)(D.A,{sx:{display:"flex",gap:1},children:[(0,i.jsx)(I.A,{color:"primary",onClick:()=>{e.push("/tenant/administration/audit-logs/searches")},startIcon:(0,i.jsx)(P.A,{fontSize:"small",children:(0,i.jsx)(o.A,{})}),children:"Back to Searches"}),(0,i.jsx)(I.A,{color:"primary",onClick:()=>p.handleOpen(),startIcon:(0,i.jsx)(E.A,{}),children:"Process Logs"})]}),apiUrl:"/api/ListAuditLogSearches",apiDataKey:"Results",simpleColumns:L,queryKey:"AuditLogSearchResults-".concat(t),apiData:{Type:"SearchResults",SearchId:t},offCanvas:{title:"Audit Log Details",size:"xl",children:e=>(0,i.jsx)(N,{row:e})},actions:[]}),(0,i.jsx)(c.B,{createDialog:p,title:"Process Logs for Alerts",api:{type:"POST",url:"/api/ExecAuditLogSearch",confirmText:"Process these logs? Note: This will only alert on logs that match your Alert Configuration rules.",relatedQueryKeys:["AuditLogSearches"],allowResubmit:!0,data:{Action:"ProcessLogs",SearchId:t}}})]})};k.getLayout=e=>(0,i.jsx)(s.P,{children:e});let $=k},46041:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var i=r(14232);let a=i.forwardRef(function(e,t){let{title:r,titleId:a,...n}=e;return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":a},n),r?i.createElement("title",{id:a},r):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"}))})},82557:(e,t,r)=>{"use strict";r.d(t,{A:()=>h});var i=r(37876),a=r(14232),n=r(76776),s=r(59568),l=r(18847),c=r.n(l),o=r(22322),u=r(33862),d=r(41412),f=r(35936);let p=c()(()=>Promise.all([r.e(789),r.e(1805),r.e(8402),r.e(5389)]).then(r.bind(r,35389)),{loadableGenerated:{webpack:()=>[35389]},ssr:!1});function h(e){let{ipAddress:t,cardProps:r,showIpAddress:l=!1,displayIpAddress:c=null}=e,[h,m]=(0,a.useState)(null),g=["timezone","as","proxy","hosting","mobile"],y=["org","city","region","country","zip"],x=c||t,j=(l?["ipAddress",...y]:y).map(e=>({label:(0,d.i)("ipAddress"===e?"IP Address":e),value:"ipAddress"===e?x:""})),[A,v]=(0,a.useState)(j),[b,S]=(0,a.useState)(null),w=(0,o.nN)({urlFromData:!0,queryKey:"GeoIPLookup-"+t,onResult:e=>{m(e);var t=[];l&&t.push({label:(0,d.i)("IP Address"),value:(0,f.i)(x,"ipAddress")}),y.map(r=>{t.push({label:(0,d.i)(r),value:(0,f.i)(e[r],r)})}),v(t),S((0,i.jsx)("div",{children:g.map(t=>(0,i.jsxs)("div",{children:[(0,i.jsxs)("strong",{children:[(0,d.i)(t),":"]})," ",(0,f.i)(e[t],t)]},t))}))}});return(0,a.useEffect)(()=>{t&&w.mutate({url:"/api/ExecGeoIPLookup",data:{IP:t}})},[t]),(0,i.jsxs)(s.A,{container:!0,spacing:2,children:[(0,i.jsx)(s.A,{size:{xs:12,sm:8},children:w.isPending?(0,i.jsx)(n.A,{variant:"rectangular",height:400}):(0,i.jsx)(i.Fragment,{children:h&&h.lat&&h.lon&&(0,i.jsx)(p,{markers:[{position:[h.lat,h.lon],popup:b}],zoom:11,mapSx:{height:"400px",width:"100%"}})})}),(0,i.jsx)(s.A,{size:{xs:12,sm:4},children:(0,i.jsx)(u.E,{propertyItems:A,showDivider:!1,isFetching:w.isPending})})]})}},99439:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var i=r(93944),a=r(37876);let n=(0,i.A)((0,a.jsx)("path",{d:"M7 9H2V7h5zm0 3H2v2h5zm13.59 7-3.83-3.83c-.8.52-1.74.83-2.76.83-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5c0 1.02-.31 1.96-.83 2.75L22 17.59zM17 11c0-1.65-1.35-3-3-3s-3 1.35-3 3 1.35 3 3 3 3-1.35 3-3M2 19h10v-2H2z"}),"ManageSearch")}},e=>{var t=t=>e(e.s=t);e.O(0,[636,6593,8792],()=>t(18550)),_N_E=e.O()}]);