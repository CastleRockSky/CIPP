"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6803],{1759:(e,l,n)=>{n.d(l,{A:()=>t});var a=n(14232);let t=a.forwardRef(function(e,l){let{title:n,titleId:t,...i}=e;return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:l,"aria-labelledby":t},i),n?a.createElement("title",{id:t},n):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"}))})},32899:(e,l,n)=>{n.d(l,{W:()=>P});var a=n(37876),t=n(14232),i=n(22474),o=n(77018),s=n(47737),r=n(94810),c=n(67578),d=n(46061),u=n(76776),m=n(7881),p=n(88326),h=n(37746),x=n(59568),v=n(22322),j=n(57016),f=n(35764);let A=(0,n(93944).A)((0,a.jsx)("path",{d:"M1 21h22L12 2zm12-3h-2v-2h2zm0-4h-2v-4h2z"}),"WarningOutlined");var b=n(409),y=n(87505),g=n(58105),w=n(88992),R=n(1759),N=n(68723);let E=JSON.parse('{"readonly":{"include":["*.Read"],"exclude":["CIPP.SuperAdmin.*"]},"editor":{"include":["*.Read","*.ReadWrite"],"exclude":["CIPP.SuperAdmin.*","CIPP.Admin.*","CIPP.AppSettings.*","Tenant.Standards.ReadWrite"]},"admin":{"include":["*"],"exclude":["CIPP.SuperAdmin.*"]},"superadmin":{"include":["*"],"exclude":[]}}'),P=e=>{var l;let{selectedRole:n}=e,P=(0,v.nN)({urlFromData:!0,relatedQueryKeys:["customRoleList","customRoleTable"]}),[C,k]=(0,t.useState)(!1),[T,I]=(0,t.useState)(!1),[S,F]=(0,t.useState)(null),[G,O]=(0,t.useState)(!1),[W,D]=(0,t.useState)({}),[L,z]=(0,t.useState)(!1),K=(0,w.mN)({mode:"onChange"}),B=(0,w.lN)({control:K.control}),q=(0,w.FH)({control:K.control,name:"allowedTenants"}),H=(0,w.FH)({control:K.control,name:"blockedTenants"}),V=(0,w.FH)({control:K.control,name:"Defaults"}),_=(0,w.FH)({control:K.control,name:"Permissions"}),Z=(0,w.FH)({control:K.control,name:"EntraGroup"}),{data:M=[],isFetching:J,isSuccess:Q}=(0,v.R_)({url:"/api/ExecAPIPermissionList",queryKey:"apiPermissions"}),{data:U=[],isFetching:$,isSuccess:X}=(0,v.Zs)({url:"/api/ExecCustomRole",queryKey:"customRoleList"}),{data:{pages:Y=[]}={},isSuccess:ee}=(0,v.Zs)({url:"/api/ListTenants?AllTenantSelector=true",queryKey:"ListTenants-AllTenantSelector"}),el=Y[0]||[],en=(e,l)=>new RegExp("^".concat(e.replace("*",".*"),"$")).test(l),ea=e=>{let l=E[e];if(!l)return{};let n={};return Object.keys(M).forEach(e=>{Object.keys(M[e]).forEach(a=>{let t=l.include.some(l=>en(l,"".concat(e,".").concat(a,".Read"))),i=l.include.some(l=>en(l,"".concat(e,".").concat(a,".ReadWrite"))),o=l.exclude.some(l=>en(l,"".concat(e,".").concat(a,".Read"))),s=l.exclude.some(l=>en(l,"".concat(e,".").concat(a,".ReadWrite")));(t||i)&&!(o||s)&&(n[e]||(n[e]={}),n[e][a]=i?"ReadWrite":"Read"),n[e]&&n[e][a]||(n[e]||(n[e]={}),n[e][a]="None")})}),n};(0,t.useEffect)(()=>{n&&E[n]?(D(ea(n)),z(!0)):(D({}),z(!1))},[n,M]),(0,t.useEffect)(()=>{if(X&&ee&&n&&S!==n||W){F(n),I("api-role"===n);let s=null==U?void 0:null===(l=U.pages)||void 0===l?void 0:null===(e=l[0])||void 0===e?void 0:e.find(e=>e.RowKey===n);var e,l,a,t,i=[];null==s||null===(a=s.AllowedTenants)||void 0===a||a.forEach(e=>{if("object"==typeof e&&"Group"===e.type)i.push({label:e.label,value:e.value,type:"Group"});else{var l=el.find(l=>l.customerId===e);if(null==l?void 0:l.displayName){var n="".concat(l.displayName," (").concat(l.defaultDomainName,")");i.push({label:n,value:l.defaultDomainName,type:"Tenant",addedFields:{defaultDomainName:l.defaultDomainName,displayName:l.displayName,customerId:l.customerId}})}}});var o=[];null==s||null===(t=s.BlockedTenants)||void 0===t||t.forEach(e=>{if("object"==typeof e&&"Group"===e.type)o.push({label:e.label,value:e.value,type:"Group"});else{var l=el.find(l=>l.customerId===e);if(null==l?void 0:l.displayName){var n="".concat(l.displayName," (").concat(l.defaultDomainName,")");o.push({label:n,value:l.defaultDomainName,type:"Tenant",addedFields:{defaultDomainName:l.defaultDomainName,displayName:l.displayName,customerId:l.customerId}})}}});let r={};Object.entries(ea(n)).forEach(e=>{let[l,n]=e;Object.entries(n).forEach(e=>{let[n,a]=e;r["".concat(l).concat(n)]="".concat(l,".").concat(n,".").concat(a)})}),K.reset({Permissions:r&&Object.keys(r).length>0?r:(e=>{let l={};return Object.keys(M).forEach(n=>{Object.keys(M[n]).forEach(a=>{let t="".concat(n).concat(a),i=null==e?void 0:e[t];l[t]=i||"".concat(n,".").concat(a,".None")})}),l})(null==s?void 0:s.Permissions),RoleName:null!=n?n:null==s?void 0:s.RowKey,allowedTenants:i,blockedTenants:o,EntraGroup:null==s?void 0:s.EntraGroup})}},[U,X,ee,W]),(0,t.useEffect)(()=>{if(G!==V){O(V);var e={};Object.keys(M).forEach(l=>{Object.keys(M[l]).forEach(n=>{var a="";a="CIPP"==l&&"Core"==n&&"None"==V?"Read":V,e["".concat(l).concat(n)]="".concat(l,".").concat(n,".").concat(a)})}),K.setValue("Permissions",e)}},[V,G]),(0,t.useEffect)(()=>{var e=!1;null==q||q.map(l=>{(null==l?void 0:l.value)==="AllTenants"&&(e=!0)}),e?k(!0):k(!1)},[q,H]),(0,t.useEffect)(()=>{n&&K.setValue("RoleName",n)},[n]);let et=e=>{let{obj:l,cat:n,readOnly:c}=e,[d,u]=(0,t.useState)(!1);var m=[];for(var p in M[n][l])for(var h in M[n][l][p])m.push({heading:"",content:M[n][l][p][h]});return(0,a.jsxs)(i.A,{direction:"row",display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",children:[(0,a.jsx)(o.A,{variant:"h6",children:l}),(0,a.jsxs)(i.A,{direction:"row",spacing:3,size:{xl:8},children:[(0,a.jsx)(s.A,{onClick:()=>u(!0),size:"sm",color:"info",children:(0,a.jsx)(r.A,{fontSize:"small",children:(0,a.jsx)(R.A,{})})}),(0,a.jsx)(g.A,{type:"radio",row:!0,name:"Permissions.".concat(n).concat(l),options:[{label:"None",value:"".concat(n,".").concat(l,".None"),disabled:"CIPP"===n&&"Core"===l},{label:"Read",value:"".concat(n,".").concat(l,".Read"),disabled:c},{label:"Read / Write",value:"".concat(n,".").concat(l,".ReadWrite")}],formControl:K,disabled:c})]}),(0,a.jsx)(j.w,{visible:d,onClose:()=>{u(!1)},children:(0,a.jsxs)(i.A,{spacing:2,children:[(0,a.jsx)(o.A,{variant:"h3",sx:{mx:3},children:"".concat(n,".").concat(l)}),(0,a.jsx)(o.A,{variant:"body1",sx:{mx:3},children:"Listed below are the available API endpoints based on permission level, ReadWrite level includes endpoints under Read."}),[M[n][l]].map((e,l)=>Object.keys(e).map(n=>{var t=[];for(var s in e[n])t.push({heading:"",content:e[n][s]});return(0,a.jsxs)(i.A,{spacing:2,children:[(0,a.jsx)(o.A,{variant:"h4",children:n}),(0,a.jsx)(i.A,{spacing:1,children:t.map((e,l)=>(0,a.jsx)(i.A,{spacing:1,children:(0,a.jsx)(o.A,{variant:"body2",children:e.content})},l))})]},l)}))]})})]})};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(i.A,{spacing:3,direction:"row",children:[(0,a.jsxs)(c.A,{width:"80%",children:[(0,a.jsxs)(i.A,{spacing:1,sx:{mb:3},children:[!n&&(0,a.jsx)(g.A,{type:"textField",name:"RoleName",label:"Custom Role",placeholder:"Enter a unique role name",formControl:K,validators:{validate:e=>{var l,n;return null==U||null===(n=U.pages)||void 0===n||null===(l=n[0])||void 0===l||!l.some(l=>{var n;return(null==l?void 0:null===(n=l.RowKey)||void 0===n?void 0:n.toLowerCase())===(null==e?void 0:e.toLowerCase())})||"Role '".concat(e,"' already exists")}},fullWidth:!0,required:!0}),n&&L&&["admin","superadmin"].includes(n)&&(0,a.jsx)(d.A,{color:"warning",icon:(0,a.jsx)(A,{}),children:"This is a highly privileged role and overrides any custom role restrictions."}),T&&(0,a.jsx)(d.A,{color:"info",children:"This is the default role for all API clients in the CIPP-API integration. If you would like different permissions for specific applications, create a role per application and select it from the CIPP-API integrations page."}),(0,a.jsx)(g.A,{type:"autoComplete",name:"EntraGroup",label:"Entra Group Assignment",placeholder:"Select an Entra Group to assign this role to, leave blank for none.",api:{url:"/api/ExecCustomRole",data:{Action:"ListEntraGroups"},type:"GET",queryKey:"PartnerEntraGroups",dataKey:"Results",labelField:"displayName",valueField:"id"},formControl:K,fullWidth:!0,sortOptions:!0,multiple:!1,creatable:!1})]}),!L&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(i.A,{spacing:1,sx:{my:3},children:[(0,a.jsx)(f.w,{label:"Allowed Tenants",formControl:K,type:"multiple",allTenants:!0,name:"allowedTenants",fullWidth:!0,includeGroups:!0}),C&&(null==H?void 0:H.length)==0&&(0,a.jsx)(d.A,{color:"warning",children:"All tenants selected, no tenant restrictions will be applied unless blocked tenants are specified."})]}),C&&(0,a.jsx)(c.A,{sx:{mb:3},children:(0,a.jsx)(f.w,{label:"Blocked Tenants",formControl:K,type:"multiple",allTenants:!1,name:"blockedTenants",fullWidth:!0,includeGroups:!0})})]}),J&&(0,a.jsx)(u.A,{variant:"rectangle",height:500}),Q&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.A,{variant:"h5",children:"API Permissions"}),!L&&(0,a.jsxs)(i.A,{direction:"row",display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",sx:{my:2},children:[(0,a.jsx)(o.A,{variant:"body2",children:"Set All Permissions"}),(0,a.jsx)(c.A,{sx:{pr:5},children:(0,a.jsx)(g.A,{type:"radio",name:"Defaults",options:[{label:"None",value:"None"},{label:"Read",value:"Read"},{label:"Read / Write",value:"ReadWrite"}],formControl:K,row:!0})})]}),(0,a.jsx)(c.A,{children:(0,a.jsx)(a.Fragment,{children:Object.keys(M).sort().map((e,l)=>(0,a.jsxs)(m.A,{variant:"outlined",children:[(0,a.jsx)(p.A,{expandIcon:(0,a.jsx)(y.A,{}),children:e}),(0,a.jsx)(h.A,{children:Object.keys(M[e]).sort().map((n,t)=>{let i=null!=W&&!!W[e];return(0,a.jsx)(x.A,{container:!0,className:"mb-3",children:(0,a.jsx)(et,{obj:n,cat:e,readOnly:i})},"row-".concat(l,"-").concat(t))})})]},"accordion-item-".concat(l)))})})]})]}),(0,a.jsxs)(c.A,{size:{md:12,xl:3},width:"30%",children:[Z&&(0,a.jsxs)(d.A,{color:"info",children:["This role will be assigned to the Entra Group:"," ",(0,a.jsx)("strong",{children:Z.label})]}),(null==q?void 0:q.length)>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h5",{children:"Allowed Tenants"}),(0,a.jsx)("ul",{children:q.map((e,l)=>(0,a.jsx)("li",{children:null==e?void 0:e.label},l))})]}),(null==H?void 0:H.length)>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h5",{children:"Blocked Tenants"}),(0,a.jsx)("ul",{children:H.map((e,l)=>(0,a.jsx)("li",{children:null==e?void 0:e.label},l))})]}),_&&Q&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h5",{children:"Selected Permissions"}),(0,a.jsx)("ul",{children:_&&(null===(l=Object.keys(_))||void 0===l?void 0:l.sort().map((e,l)=>{var n;return(0,a.jsx)(a.Fragment,{children:(null==_?void 0:_[e])&&"string"==typeof _[e]&&!(null===(n=_[e])||void 0===n?void 0:n.includes("None"))&&(0,a.jsx)("li",{children:_[e]},l)})}))})]})]})]}),(0,a.jsx)(N.v,{apiObject:P}),(0,a.jsx)(i.A,{direction:"row",spacing:2,justifyContent:"flex-end",children:(0,a.jsx)(s.A,{className:"me-2",type:"submit",variant:"contained",disabled:P.isPending||$||!B.isValid,startIcon:(0,a.jsx)(r.A,{fontSize:"small",children:(0,a.jsx)(b.A,{})}),onClick:()=>{let e=K.getValues(),l=(null==q?void 0:q.map(e=>{if("Group"===e.type)return{type:"Group",value:e.value,label:e.label};{let l=el.find(l=>l.defaultDomainName===e.value);return null==l?void 0:l.customerId}}).filter(Boolean))||[],n=(null==H?void 0:H.map(e=>{if("Group"===e.type)return{type:"Group",value:e.value,label:e.label};{let l=el.find(l=>l.defaultDomainName===e.value);return null==l?void 0:l.customerId}}).filter(Boolean))||[];P.mutate({url:"/api/ExecCustomRole?Action=AddUpdate",data:{RoleName:null==e?void 0:e.RoleName,Permissions:_,EntraGroup:Z,AllowedTenants:l,BlockedTenants:n}})},children:"Save"})})]})}},36577:(e,l,n)=>{n.d(l,{A:()=>h});var a=n(37876),t=n(89099),i=n(67578),o=n(86650),s=n(22474),r=n(47737),c=n(94810),d=n(77018),u=n(54538),m=n(42120),p=n(2303);let h=e=>{let{title:l,backButtonTitle:n="Back",children:h,cardSize:x="xl",hideTitleText:v=!1,hideBackButton:j=!1,noTenantInHead:f=!1,infoBar:A}=e,b=(0,t.useRouter)();return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(p.v,{title:l,noTenant:f}),(0,a.jsx)(i.A,{sx:{flexGrow:1,py:4},children:(0,a.jsx)(o.A,{maxWidth:x,children:(0,a.jsxs)(s.A,{spacing:2,children:[(0,a.jsxs)(s.A,{spacing:2,children:[(0,a.jsx)("div",{children:!j&&(0,a.jsx)(r.A,{color:"inherit",onClick:()=>{b.back()},startIcon:(0,a.jsx)(c.A,{fontSize:"small",children:(0,a.jsx)(m.A,{})}),children:n})}),!0!==v&&(0,a.jsx)("div",{children:(0,a.jsx)(d.A,{variant:"h4",children:l})})]}),A,(0,a.jsx)(u.A,{children:h})]})})})]})}},42120:(e,l,n)=>{n.d(l,{A:()=>i});var a=n(93944),t=n(37876);let i=(0,a.A)((0,t.jsx)("path",{d:"m14 7-5 5 5 5z"}),"ArrowLeft")}}]);